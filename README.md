# 远程控制软件（更新版）

这是一个学习用途的 Python 远程控制项目，包含被控端（服务端）与控制端（客户端）两部分。
本仓库当前在功能上已扩展并改进为：支持基于 PTY 的交互式终端、带 PyQt5 GUI 的控制端、稳健的截图与画面流、以及可选的对称加密（Fernet）。

> 重要提示：本项目为学习/演示用途。请勿在生产或公网环境中使用。务必在受控、可信的网络与机器上测试。

## 主要功能（现状）

- 命令执行：通过 TCP 连接远程执行系统命令并获取输出。
- 交互式终端（PTY）：服务端优先在伪终端（PTY）中执行交互式命令，能正确运行需要 TTY 的程序（如交互式 shell、vim、sudo 等）。Windows 上的 ConPTY 支持需要额外依赖并可能回退。
- GUI 客户端：`client_gui.py` 提供基于 PyQt5 的图形界面，包含画面预览、终端视图、截图按钮、流控制预设与手动 FPS 设置。
- 实时 FPS：GUI 状态栏会显示“当前设置”与右侧的实时 FPS（每秒刷新），GUI 端统计实际接收帧数并更新展示。
- 稳定截图：截图请求使用短连接（短时独立 TCP 连接）来避免与主接收线程竞争数据，截图保存到项目根下的 `screenshot/` 文件夹。
- 画面流：支持多种预设（低延迟 / 平衡 / 省带宽）与手动 FPS/质量/缩放设置，服务端持续推送 JPEG/PNG 帧到客户端显示。
- 可选加密：支持 `cryptography.Fernet` 的对称加密（通过连接密钥进行 PBKDF2 密钥派生）。若未安装加密库或未提供密钥，通信会回退为明文（但客户端会显示相应提示）。

## 所在文件（简要）

- `server.py`：被控端，监听连接，执行命令，提供 PTY 会话、截图与画面流。
- `client.py`：命令行客户端（轻量版）。
- `client_gui.py`：PyQt5 GUI 客户端，集成实时画面流、截图、终端窗口与交互式 PTY 支持。
- `screenshot/`：默认截图保存目录（由客户端在同级目录创建）。

## 环境与依赖

推荐 Python 版本：3.8 及以上（已在 3.9 下测试）。

必要依赖（最低，命令行功能）：

```bash
# 基本功能（命令执行）仅依赖标准库
```

可选/推荐依赖（GUI、画面传输、加密）：

```bash
pip install PyQt5 pillow mss cryptography
```

说明：
- `PyQt5`：用于 `client_gui.py` 图形界面。
- `pillow`（PIL）与 `mss`：用于屏幕截图与图像处理。
- `cryptography`：启用 Fernet 对称加密（可选）。

Windows ConPTY：若需要在 Windows 上完整支持 ConPTY/伪终端，可能需要额外包（例如 `pywinpty` 或 `conpty` 相关绑定）。当前实现优先在 Unix-like 系统使用 `pty`，Windows 会回退并提示。

## 快速入门

1. 启动服务端（被控端）

```bash
python server.py
```

2. 启动控制端（命令行）

```bash
python client.py -H <host> -p 8888
```

3. 启动带界面的控制端（推荐桌面环境）

```bash
python client_gui.py
```

客户端启动后会弹出连接对话框，填写服务器地址、端口与（如需）连接密钥。若填写密钥并且服务端也支持加密，则通信将使用基于该密钥的 Fernet 对称加密。

## GUI 功能说明（`client_gui.py`）

- 状态栏：左侧显示当前流参数（FPS、质量、缩放），右侧显示实时接收 FPS（每秒刷新）。
- 预设按钮：三种一键预设 — 低延迟（高 FPS）、平衡（默认）、省带宽（低 FPS/低质量）。
- 手动 FPS：输入数字后点击“设置FPS并重启流”会以新 FPS 重启画面流（保留其他参数）。
- 截图按钮：使用独立短连接请求截图，保存到 `screenshot/` 文件夹，并在完成后恢复按钮状态（线程安全）。
- 终端标签：支持发送命令并展示来自服务器的 ANSI 输出；输入以回车发送。
- PTY 交互：以 `pty:` 前缀发送命令（或通过 GUI 提供的入口），会在服务端创建伪终端并在一个独立的 `TerminalDialog` 窗口中进行交互，客户端将按键作为原始字节转发至服务端。

注意：GUI 终端使用基于 `QTextEdit` 的简化渲染，支持常见 ANSI SGR 颜色、加粗与下划线，但并不是完整终端仿真器。

## 常用命令（服务端支持）

- `screenshot -q <质量> -s <缩放>`：获取截图（JPEG），例如 `screenshot -q 70 -s 0.5`。
- `stream -fps <n> -q <质量> -s <缩放>`：开始画面流（服务端由客户端短连接/流线程发起）；客户端 GUI 会以 StreamThread 接收并显示。
- `stop_stream`：停止画面流（由客户端发送）。
- `pty:<command>`：在服务端启动 PTY 会话并进入交互模式（客户端会弹出交互窗口并将按键原样发送）。

## 加密与认证

项目支持基于 `cryptography.Fernet` 的对称加密：

- 客户端在连接时若提供密钥，会在握手阶段使用 PBKDF2（固定 salt）派生出 Fernet 密钥并与服务端完成认证/加密协商。
- 若不提供密钥或未安装 `cryptography`，通信退回为明文（客户端会打印警告）。

安全提示：Fernet 对称加密在本项目仅作为可选传输保护。如需在不受信网络中使用，请引入更完整的认证和加密机制（例如 TLS、双向认证、最小化权限的服务端逻辑等）。

## Windows 注意事项

- 服务端上在 Unix-like 系统上会优先使用 `pty` 模块创建伪终端，Windows 的原生支持有限，完整 ConPTY 支持需要额外依赖与测试。
- 中文编码：客户端会尝试按 `utf-8` → `cp936` → `latin-1` 的顺序进行解码以减少中文乱码问题，但在某些环境下仍可能需要手动调整代码页或使用完整的终端仿真器。

## 故障排查

- 如果 GUI 无法显示画面：确认 `pillow` 与 `mss` 已安装，并检查服务端日志是否有图片发送记录。
- 如果交互式程序无法正常工作：确认服务端支持 PTY（在 Windows 上可能回退）；查看服务端是否收到 `pty:` 请求并成功创建伪终端。
- 截图请求失败但服务端显示已发送：客户端现在使用短连接接收截图，请检查防火墙/网络是否阻止额外的短连接。

## 运行与开发建议

- 若要改进终端仿真效果，可在 `client_gui.py` 中替换或集成成熟的终端控件（例如 `QTermWidget`）。
- 若需 Windows 上完整 PTY 行为，请调研并尝试集成 `pywinpty`/`winpty` 或 Windows 10+ 的 ConPTY API 的 Python 绑定。

## 许可证

仅作学习用途，无商业/运维保障。请勿在生产环境中使用。

---

如需我将 README 中的某个示例扩展为更详细的“入门教程（截图 + GUI 操作步骤）”，或生成快速截图/流测试脚本，请告诉我想要的格式（Markdown/HTML/短视频说明）。
# 远程控制软件

一个基于Python的远程控制软件，分为控制端和被控端两部分。

## 功能特性

- ✅ 基本的远程命令执行
- ✅ 交互式命令行界面
- ✅ 多客户端支持（服务端）
- ✅ 命令执行结果返回
- ✅ 错误处理和超时保护
- ✅ **画面传输功能** - 远程截图并显示/保存
- ✅ **实时画面流** - 持续传输屏幕画面（类似远程桌面）
 - ✅ **图形化控制端（GUI）** - `client_gui.py`，基于 PyQt5，提供实时画面流、截图按钮、终端窗口与交互式 PTY 会话

## 使用方法

### 1. 启动被控端（服务端）

```bash
python server.py
```

默认监听 `0.0.0.0:8888`，可以通过参数自定义：

```bash
python server.py -H 0.0.0.0 -p 8888
```

### 2. 启动控制端（客户端）

#### 交互模式（推荐）

```bash
python client.py
```

默认连接到 `localhost:8888`，可以指定地址和端口：

```bash
python client.py -H 192.168.1.100 -p 8888
```

#### 执行单个命令

```bash
python client.py -H 192.168.1.100 -p 8888 -c "dir"
```

#### 图形化客户端（GUI）

使用 `client_gui.py` 启动带界面的控制端（推荐在桌面环境下使用）：

```bash
python client_gui.py
```

GUI 功能亮点：
- 实时画面流显示与三种预设（低延迟 / 平衡 / 省带宽）；支持手动设置 FPS 并重启流。
- 状态栏显示“当前设置”并在右侧显示实时 FPS（每秒刷新）。
- 一键截图（使用独立短连接请求，避免与主接收线程竞争），截图会保存到项目根目录下的 `screenshot/` 文件夹。
- 交互式终端支持 PTY 模式（在服务端创建伪终端），能够正确运行交互式程序（如 vim、sudo shell 等）。

注意事项：
- GUI 终端使用基于 QTextEdit 的简化渲染，支持常见 ANSI SGR 颜色与样式，但不是完整的终端模拟器。需要更精确的终端行为时建议集成专用终端控件（例如 QTermWidget）。
- Windows 上完整的 ConPTY 支持需额外依赖（例如 `pywinpty`），本项目目前在服务端优先使用 unix `pty`，Windows 上会回退或提示。

## 使用示例

### 被控端
```bash
$ python server.py
[*] 服务器启动成功，监听 0.0.0.0:8888
[*] 等待控制端连接...
[+] 新的连接来自: 192.168.1.50:54321
[*] 收到命令: dir
```

### 控制端
```bash
$ python client.py -H 192.168.1.100
[+] 成功连接到 192.168.1.100:8888
[*] 进入交互模式
[*] 输入命令执行，输入 'exit' 退出，输入 'quit' 断开连接

[192.168.1.100]> dir
 驱动器 C 中的卷是 Windows
 卷序列号是 XXXX-XXXX

 C:\Users\86166\Desktop\远控 的目录
...

[192.168.1.100]> exit
[*] 已断开连接
```

### 画面传输功能

#### 安装依赖

首先需要安装画面传输所需的依赖：

```bash
pip install pillow mss
```

#### 使用截图功能

在交互模式下，输入 `screenshot` 命令即可获取被控端的屏幕截图：

```bash
[192.168.1.100]> screenshot
[+] 截图已保存到: C:\Users\86166\Desktop\远控\screenshot\screenshot_20241230_133254.jpg
[+] 截图已显示
```

**默认保存位置**：截图会自动保存到当前目录下的 `screenshot` 文件夹中，文件名格式为 `screenshot_YYYYMMDD_HHMMSS.jpg`

#### 截图命令参数详解

**命令格式**：
```bash
screenshot [选项]
```

**参数说明**：

| 参数 | 类型 | 说明 | 默认值 | 示例 |
|------|------|------|--------|------|
| `-q <质量>` | 整数 | JPEG压缩质量，范围 1-100。数值越高画质越好但文件越大 | 70 | `-q 90` |
| `-s <缩放>` | 浮点数 | 图片缩放比例，范围 0.1-1.0。小于1.0会缩小图片，减少传输量 | 1.0 | `-s 0.5` |
| `-o <路径>` | 字符串 | 指定截图保存路径。可以是相对路径或绝对路径。如果不指定，默认保存到 `screenshot` 目录 | 自动生成 | `-o screen.jpg` |
| `--no-show` | 标志 | 不自动打开图片查看器，仅保存文件 | 显示 | `--no-show` |

**使用示例**：

```bash
# 基本用法：使用默认参数（质量70，不缩放，自动保存并显示）
[192.168.1.100]> screenshot

# 高质量截图：提高JPEG质量到90
[192.168.1.100]> screenshot -q 90

# 缩小截图：缩小50%以减少传输量（适合慢速网络）
[192.168.1.100]> screenshot -s 0.5

# 组合参数：高质量+缩小+保存到指定位置
[192.168.1.100]> screenshot -q 90 -s 0.6 -o my_screen.jpg

# 仅保存不显示：适合批量截图场景
[192.168.1.100]> screenshot --no-show

# 低质量快速传输：适合网络较差的情况
[192.168.1.100]> screenshot -q 40 -s 0.3
```

**参数组合建议**：

- **高质量截图**：`screenshot -q 95 -s 1.0`
- **快速传输（慢速网络）**：`screenshot -q 50 -s 0.4`
- **平衡模式（推荐）**：`screenshot -q 70 -s 0.7`
- **批量保存**：`screenshot --no-show`

#### 实时画面流功能 🆕

在交互模式下，输入 `stream` 命令即可启动实时画面传输，会打开一个新窗口持续显示被控端的屏幕：

```bash
[192.168.1.100]> stream
[*] 启动实时画面流 (FPS: 5, 质量: 50, 缩放: 0.5)
[*] 按 Ctrl+C 或关闭窗口停止
```

#### 画面流命令参数详解

**命令格式**：
```bash
stream [选项]
```

**参数说明**：

| 参数 | 类型 | 说明 | 默认值 | 示例 |
|------|------|------|--------|------|
| `-fps <帧率>` | 整数 | 每秒传输帧数，范围 1-30。帧率越高画面越流畅，但需要更好的网络带宽 | 5 | `-fps 10` |
| `-q <质量>` | 整数 | JPEG压缩质量，范围 1-100。数值越高画质越好但传输数据量越大 | 50 | `-q 60` |
| `-s <缩放>` | 浮点数 | 图片缩放比例，范围 0.1-1.0。小于1.0会缩小画面，减少传输量 | 0.5 | `-s 0.6` |

**使用示例**：

```bash
# 基本用法：使用默认参数（5fps，质量50，缩放0.5）
[192.168.1.100]> stream

# 高帧率流畅画面：适合网络较好的情况
[192.168.1.100]> stream -fps 10 -q 60 -s 0.6

# 低质量快速传输：适合慢速网络或需要降低延迟
[192.168.1.100]> stream -fps 3 -q 30 -s 0.3

# 高质量画面：牺牲流畅度换取画质
[192.168.1.100]> stream -fps 3 -q 80 -s 0.8

# 平衡模式：在流畅度和画质之间平衡
[192.168.1.100]> stream -fps 8 -q 60 -s 0.5
```

**参数组合建议**：

- **流畅模式（推荐，网络良好）**：`stream -fps 10 -q 60 -s 0.6`
- **画质优先（网络良好）**：`stream -fps 5 -q 80 -s 0.8`
- **速度优先（慢速网络）**：`stream -fps 3 -q 40 -s 0.3`
- **默认模式（平衡）**：`stream`（使用默认参数）

**注意**：
- 实时画面流会打开一个新窗口显示画面
- 关闭窗口或按 Ctrl+C 可停止画面流
- 画面流停止后会自动重新连接，可继续使用其他命令
- 建议根据网络情况调整参数以平衡流畅度和画质

## 安全提示

⚠️ **警告**: 这是一个基础实现，仅用于学习和测试目的。

- 当前版本没有身份验证机制
- 没有加密传输
- 可以执行任意系统命令

注：本项目支持基于 `cryptography.Fernet` 的可选对称加密（通过 `client_gui.py`/`client.py` 使用连接密钥开启）。若要启用加密，需安装 `cryptography` 并在连接对话框中填写密钥；服务端也需相应配置以启用认证。若未安装加密库，通信仍回退为明文（但会显示警告）。

**请勿在生产环境或公网使用！**

## 系统要求

- Python 3.6+

## 依赖

### 基础功能
基础功能（命令执行）仅使用Python标准库，无需安装额外依赖。

推荐安装（GUI/加密/流式体验）：

```bash
pip install PyQt5 pillow mss cryptography
```

#### 实时画面流功能 🆕

在交互模式下，输入 `stream` 命令即可启动实时画面传输，会打开一个新窗口持续显示被控端的屏幕：
```bash
pip install -r requirements.txt
```

或手动安装：

```bash
pip install pillow mss
```

**注意**：实时画面流功能需要 `tkinter`（通常Python自带，Linux可能需要单独安装）


## 许可证

本项目仅供学习使用。

